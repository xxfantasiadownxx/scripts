#!/bin/bash

# List of users to exclude from deletion
EXCLUDE_USERS=("Atlas" "berklgre" "daemon" "nobody" "root" "Support")

# Date 30 days ago in epoch time
THIRTY_DAYS_AGO=$(date -v-30d +%s)

# Temporary file to store users to delete
TEMP_FILE=$(mktemp)

# Get all non-system users
while read user; do
  # Check if user is in exclusion list
  if [[ " ${EXCLUDE_USERS[@]} " =~ " ${user} " ]]; then
    continue
  fi
  
  # Get last login info
  last_login=$(last -1 "$user" | head -1 | grep -v 'wtmp begins')
  
  # Check if user never logged in
  if [[ -z "$last_login" ]]; then
    echo "Will delete: $user (Never logged in)"
    echo "$user" >> "$TEMP_FILE"
    continue
  fi
  
  # Extract the login date from last command output
  # Format: username console/ttys Mon Nov 10 13:13 ...
  login_date=$(echo "$last_login" | awk '{print $4, $5, $6}')
  
  # Check if login shows "still logged in" - these are recent
  if echo "$last_login" | grep -q "still logged in"; then
    continue
  fi
  
  # Convert login date to epoch time
  login_epoch=$(date -j -f "%b %d %H:%M" "$login_date" +%s 2>/dev/null)
  
  # If date conversion failed, skip this user
  if [[ -z "$login_epoch" ]]; then
    continue
  fi
  
  # Check if last login was more than 30 days ago
  if [[ $login_epoch -lt $THIRTY_DAYS_AGO ]]; then
    echo "Will delete: $user (Last login: $login_date)"
    echo "$user" >> "$TEMP_FILE"
  fi
done < <(dscl . list /Users | grep -v '^_')

# Display summary
echo ""
echo "================================"
echo "Users to be deleted:"
echo "================================"

if [[ -s "$TEMP_FILE" ]]; then
  cat "$TEMP_FILE" | while read user; do
    echo "  - $user"
  done
  
  echo ""
  read -p "Do you want to proceed with deleting these users? (yes/no): " confirm
  
  if [[ "$confirm" == "yes" ]]; then
    while read user; do
      echo "Deleting user: $user"
      sudo sysadminctl -deleteUser "$user"
    done < "$TEMP_FILE"
    echo "Deletion complete!"
  else
    echo "Operation cancelled."
  fi
else
  echo "  (No users to delete)"
fi

# Clean up
rm "$TEMP_FILE"
