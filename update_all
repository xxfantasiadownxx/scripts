#!/bin/bash

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IP_LIST="$SCRIPT_DIR/ipaddresses.txt"
CREDENTIALS="$SCRIPT_DIR/credentials.json"
UPDATE_SCRIPT="$SCRIPT_DIR/prune_users_and_update_os"
ERROR_LOG="$SCRIPT_DIR/error_log.txt"

# Check if required files exist
if [ ! -f "$IP_LIST" ]; then
    echo "Error: ipaddresses.txt not found!"
    exit 1
fi

if [ ! -f "$CREDENTIALS" ]; then
    echo "Error: credentials.json not found!"
    exit 1
fi

if [ ! -f "$UPDATE_SCRIPT" ]; then
    echo "Error: prune_users_and_update_os script not found!"
    exit 1
fi

# Parse credentials from JSON
USERNAME=$(grep -o '"username"[[:space:]]*:[[:space:]]*"[^"]*"' "$CREDENTIALS" | sed 's/.*"username"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
PASSWORD=$(grep -o '"password"[[:space:]]*:[[:space:]]*"[^"]*"' "$CREDENTIALS" | sed 's/.*"password"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
PORT=$(grep -o '"port"[[:space:]]*:[[:space:]]*[0-9]*' "$CREDENTIALS" | sed 's/.*"port"[[:space:]]*:[[:space:]]*\([0-9]*\).*/\1/')

# Default port if not specified
if [ -z "$PORT" ]; then
    PORT=22
fi

echo "=========================================="
echo "Starting mass update process"
echo "Time: $(date)"
echo "=========================================="

# Process each IP address
while IFS= read -r IP || [ -n "$IP" ]; do
    # Skip empty lines
    [ -z "$IP" ] && continue
    
    echo ""
    echo "Processing: $IP"
    echo "------------------------------------------"
    
    # Test if host is reachable
    if ! ping -c 1 -W 2 "$IP" &> /dev/null; then
        echo "ERROR: $IP is not reachable"
        echo "[$(date)] $IP - Host unreachable" >> "$ERROR_LOG"
        continue
    fi
    
    # Attempt SSH connection and run update script
    # Using expect to handle password authentication without homebrew dependencies
    
    expect << EOF 2>&1 | tee /tmp/ssh_output_$.log
set timeout 30
spawn ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -p $PORT $USERNAME@$IP "bash -s" < $UPDATE_SCRIPT
expect {
    "password:" {
        send "$PASSWORD\r"
        expect {
            "Failed to authenticate" {
                puts "AUTH_FAILED"
                exit 1
            }
            "Permission denied" {
                puts "AUTH_FAILED"
                exit 1
            }
            eof {
                exit 0
            }
        }
    }
    "Permission denied" {
        puts "AUTH_FAILED"
        exit 1
    }
    timeout {
        puts "CONNECTION_TIMEOUT"
        exit 1
    }
    eof {
        exit 0
    }
}
EOF
    SSH_EXIT_CODE=$?
    
    # Check for authentication failures
    if grep -q "Failed to authenticate\|Permission denied\|Authentication failed" /tmp/ssh_output_$$.log; then
        echo "ERROR: Authentication failed for $IP"
        echo "[$(date)] $IP - Failed to authenticate" >> "$ERROR_LOG"
        rm -f /tmp/ssh_output_$$.log
        continue
    fi
    
    # Check SSH exit code
    if [ $SSH_EXIT_CODE -ne 0 ]; then
        echo "ERROR: SSH command failed for $IP (exit code: $SSH_EXIT_CODE)"
        echo "[$(date)] $IP - SSH command failed (exit code: $SSH_EXIT_CODE)" >> "$ERROR_LOG"
        rm -f /tmp/ssh_output_$$.log
        continue
    fi
    
    # Clean up temp log
    rm -f /tmp/ssh_output_$$.log
    
    echo "SUCCESS: $IP processed successfully"
    
    # Wait a moment before processing next host
    sleep 2
    
done < "$IP_LIST"

echo ""
echo "=========================================="
echo "Mass update process completed"
echo "Time: $(date)"
echo "Check $ERROR_LOG for any errors"
echo "=========================================="
