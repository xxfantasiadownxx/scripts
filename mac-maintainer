#!/bin/bash

# Interactive macOS Maintenance Script

# Function to uninstall Papercut
uninstall_papercut() {
  echo "========================================"
  echo "           Uninstall Papercut"
  echo "========================================"
  echo ""
  echo "The users currently logged into this system are: "
  sudo "/Applications/PaperCut Print Deploy Client/Uninstall.command"
}

# Function to rename device based on serial
rename_device() {
  echo "========================================"
  echo "             Rename the Mac             "
  echo "========================================"
  echo ""
  echo "The users currently logged into this system are: "
  SERIAL=$(ioreg -l | grep IOPlatformSerialNumber | awk '{print $4}' | sed 's/"//g') && sudo scutil --set ComputerName "WCPS-$SERIAL" && sudo scutil --set LocalHostName "WCPS-$SERIAL" && sudo scutil --set HostName "WCPS-$SERIAL"
}

prune_users() {
  echo "========================================"
  echo "     Pruning Inactive User Accounts"
  echo "========================================"
  echo ""

  # List of users to exclude from deletion
  EXCLUDE_USERS=("Atlas" "berklgre" "daemon" "nobody" "root" "Support")

  # Date 30 days ago in epoch time
  THIRTY_DAYS_AGO=$(date -v-30d +%s)

  # Temporary file to store users to delete
  TEMP_FILE=$(mktemp)

  # Get all non-system users
  while read user; do
    # Check if user is in exclusion list
    if [[ " ${EXCLUDE_USERS[@]} " =~ " ${user} " ]]; then
      continue
    fi
    
    # Get last login info
    last_login=$(last -1 "$user" | head -1 | grep -v 'wtmp begins')
    
    # Check if user never logged in
    if [[ -z "$last_login" ]]; then
      echo "Will delete: $user - Never logged in"
      echo "$user" >> "$TEMP_FILE"
      continue
    fi
    
    # Extract the login date from last command output
    login_date=$(echo "$last_login" | awk '{print $4, $5, $6}')
    
    # Check if login shows "still logged in" - these are recent
    if echo "$last_login" | grep -q "still logged in"; then
      continue
    fi
    
    # Convert login date to epoch time
    login_epoch=$(date -j -f "%b %d %H:%M" "$login_date" +%s 2>/dev/null)
    
    # If date conversion failed, skip this user
    if [[ -z "$login_epoch" ]]; then
      continue
    fi
    
    # Check if last login was more than 30 days ago
    if [[ $login_epoch -lt $THIRTY_DAYS_AGO ]]; then
      echo "Will delete: $user - Last login: $login_date"
      echo "$user" >> "$TEMP_FILE"
    fi
  done < <(dscl . list /Users | grep -v '^_')

  # Display summary
  echo ""
  echo "Users to be deleted:"
  echo "--------------------"

  if [[ -s "$TEMP_FILE" ]]; then
    cat "$TEMP_FILE" | while read user; do
      echo "  - $user"
    done
    
    echo ""
    read -p "Do you want to proceed with deleting these users? (yes/no): " confirm
    
    if [[ "$confirm" == "yes" ]]; then
      while read user; do
        echo "Deleting user: $user"
        sudo sysadminctl -deleteUser "$user"
      done < "$TEMP_FILE"
      echo "User deletion complete!"
    else
      echo "User deletion cancelled."
    fi
  else
    echo "  (No users to delete)"
  fi

  # Clean up temp file
  rm "$TEMP_FILE"
  echo ""
}

# Function to check FileVault encryption status
check_filevault() {
  echo "========================================"
  echo "  Checking FileVault Encryption Status"
  echo "========================================"
  echo ""
  
  FV_STATUS=$(fdesetup status)
  echo "$FV_STATUS"
  
  if echo "$FV_STATUS" | grep -q "FileVault is On"; then
    echo ""
    echo "✓ FileVault is enabled and protecting this disk."
  elif echo "$FV_STATUS" | grep -q "FileVault is Off"; then
    echo ""
    echo "✗ FileVault is NOT enabled. Disk is not encrypted."
  fi
  echo ""
}

# Function to disable FileVault prompts
disable_filevault_prompts() {
  echo "========================================"
  echo "    Disabling FileVault Notification"
  echo "========================================"
  echo ""

  echo "Disabling FileVault setup notification prompts..."
  sudo defaults write /Library/Preferences/com.apple.MCXNotifications.plist FileVaultSetup -bool FALSE

  # Kill the notification center to apply changes
  killall NotificationCenter 2>/dev/null || true

  echo "FileVault notification prompts have been disabled."
  echo ""
}

# Function to check currently logged in users
check_logged_in_users() {
  echo "========================================"
  echo "        Checking Users Logged In"
  echo "========================================"
  echo ""
  echo "The users currently logged into this system are: "
  who
  echo ""
}

# Function to check for macOS updates
check_updates() {
  echo "========================================"
  echo "       Checking for macOS Updates"
  echo "========================================"
  echo ""

  # Check for available updates
  echo "Searching for available software updates..."
  UPDATE_OUTPUT=$(softwareupdate -l 2>&1)

  # Extract the label (looks for lines starting with "* Label:")
  UPDATE_LABEL=$(echo "$UPDATE_OUTPUT" | grep "^\* Label:" | head -1 | sed 's/^\* Label: //')

  if [[ -z "$UPDATE_LABEL" ]]; then
    echo "No macOS updates found."
    echo ""
    echo "$UPDATE_OUTPUT"
  else
    echo "Found update: $UPDATE_LABEL"
    echo ""
    read -p "Do you want to install this update and restart? (yes/no): " update_confirm
    
    if [[ "$update_confirm" == "yes" ]]; then
      echo ""
      echo "Installing update: $UPDATE_LABEL"
      echo "The system will restart after installation..."
      sudo softwareupdate -i "$UPDATE_LABEL" --restart
    else
      echo "Update installation cancelled."
    fi
  fi
  echo ""
}

# Main menu
show_menu() {
  clear
  echo ""
  echo "========================================"
  echo "        macOS Maintenance Script"
  echo "========================================"
  echo ""
  echo "1. Uninstall Papercut"
  echo "2. Rename the Mac"
  echo "3. Prune user accounts that haven't logged in for 30+ days"
  echo "4. Check for FileVault disk encryption"
  echo "5. Disable FileVault notifications"
  echo "6. Check currently logged in users"
  echo "7. Check for macOS updates"
  echo "8. Prune, Disable FileVault Notifications, and Update macOS"
  echo "0. Exit"
  echo ""
  read -p "What function would you like to perform? " choice
  echo ""
}

# Main script execution
while true; do
  show_menu
  
  case $choice in
    1)
      uninstall_papercut
      ;;
    2)
      rename_device
      ;;
    3)
      prune_users
      ;;
    4)
      check_filevault
      ;;
    5)
      disable_filevault_prompts
      ;;
    6)
      check_logged_in_users
      ;;
    7)
      check_updates
      ;;
    8)
      prune_users
      disable_filevault_prompts
      check_logged_in_users
      check_updates
      echo "========================================"
      echo "           All tasks complete"
      echo "========================================"
      ;;
    0)
      echo "Exiting..."
      clear
      rm -rf mac-maintainer
      exit 0
      ;;
    *)
      echo "Invalid option. Please choose 0-6."
      ;;
  esac
  
  read -p "Press Enter to return to menu..."
done
